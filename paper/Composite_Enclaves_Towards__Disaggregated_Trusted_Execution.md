    研究背景
    
    
    由于目前不断增长的计算需求，计算任务由CPU移动到了各种异构的专门硬件。在这些现代异构架构平台上，CPU的主要任务是将数据移动到相关的专用硬件上，搜集计算结果，并将计算结果提供给可能的另一个设备。
    与此同时，由于现代操作系统和管理程序的高度复杂化，出现了大量的操作系统和管理程序的相关漏洞，因此我们希望安全依赖能够更小、更底层，并减少可信计算基。这也就催生出了可信执行环境(TEE)。不同TEE之间的设计差别很大，
但是他们通常可以在不依赖操作系统和管理程序的前提下隔离应用的执行环境。TEE只依赖于CPU的硬件原语，对于平台的所有其他硬件组件都被认为是恶意的。
    这两方面的发展有着明显的脱节，要结合Intel SGX风格的TEE和专门的硬件需要信任操作系统(可能会导致的风险例如 不被信任的OS可以读取并修改从键盘向SGX enclave的输入)；另一种风格的TEE，Arm TrustZone允许在设计时将
硬件TCB扩展到片上外围设备中，但是安全的操作系统必须包括所有专门硬件的驱动程序，即便这些专门硬件没有被大多数的enclave所使用(导致的问题，例如一个只需要键盘进行用户输入的enclave需要信任大量摄像头)。简而言之，
现有的TEE很难在遵守最低特权原则的同时支持专门的硬件。



    基于这样的观察，本文提出了带有可配置软硬件TCB的复合enclave。复合enclave由多个分布在多个硬件组件上的单元enclave组成(比如复合enclave可能由一个GPU上的enclave和一个CPU上的enclave组成)。
    同时，与传统TEE类似，复合enclave也可以进行远程认证，但除了要发送软件TCB的报告同时，还需要报告复合enclave的硬件组件。为此，我们拓展了传统的认证机制，以包括复合系统的完整性。
    此外，由于不受信任的操作系统可以在运行时将专门的硬件设备重新映射到不可信设备上(导致硬件的隐私数据泄露)，因此单元enclave需要在系统配置更改时接到通知，并能实现中断执行，直到重新测试。我们称这样的属性为平台意识(platform awareness)我们通过向enclave的生命周期内引入两个新的事件:连接(connect)和断开连接(disconnect)来实现他，这两个事件允许一个单元enclave跟踪另一个单元enclave的活力。
    我们的实验在RISC-V和Keystone上进行开发，减少了enclave到enclave通信时上下文切换的开销，并且允许enclave直接与专门硬件进行通信，因为这些通信是基于内存映射的，因此还允许对于现存驱动程序的重用。同时，我们修改了keystone的物理内存保护(PMP)，让enclave的内存部分重叠，实现共享内存。
    简述本文的工作内容如下:
        1、扩展了传统的TEE，即enclave的TCB只包含专用硬件的固件以及驱动程序。确定了这些系统相关的两个新的属性，一种更加全面的复合enclave认证体系以及平台意识。提出一种软件设计，抽象底层硬件层，以简化与现有应用程
    序和驱动程序生态系统的集成。
        2、详细分析了该方法的安全性能，包括设计决策以及许多相关的侧信道的安全影响。
        3、展示了基于keystone以及GPU的两个案例研究。

    攻击模型

    攻击模型与专用硬件的类型紧密相关，因此我们将专用硬件分为两类：
        1、带有物理交互的专用硬件:仅输入设备、仅输出设备以及组合IO设备。对于这样的设备，本地物理敌手可以操控环境，从而操控输入以及潜在的输出，因此任何与外界进行交互的特殊硬件都不能容忍物理敌手。
        2、没有物理交互的专用硬件:如GPU和其他加速器，他们的输入输出与环境无关，因此可以容忍本地物理敌手。
    在本文中，我们考虑一个控制了整个软件堆栈的远程攻击者，即可以控制操作系统以及管理程序。虽然这种攻击与现有TEE考虑的本地物理攻击者相比较弱，但是已经能涵盖上述两种专门硬件。不受信任的操作系统仍然负责管理硬件，
    因此能够进行设备重映射以及发送重置或者关闭信号。此外，对手可以通过rogue外围设备发起DMA攻击。我们假设CPU固件是可信的。对于侧信道攻击以及拒绝服务攻击的考虑超出了本文的范围，但是后续也会讨论对于现存侧信道攻击的影响。

    安全目标
    1、enclave保护:enclave中的私有数据必须要吃机密性和完整性，同时需要抵抗恶意enclave、DMA攻击以及恶意的专用硬件。
    2、专用硬件的安全集成:机密硬件应该能够集成到enclave中，并且它们之间的通信必须要保持机密性和完整性。
    3、认证:对于enclave的认证不仅需要覆盖代码以及处理器，还需要覆盖专用硬件。

    概述

    在现代平台上，处理器与专用硬件设备进行通信主要有两种机制:内存映射IO(MMIO)以及直接内存访问(DMA)。在我们的设计中，单元enclave在共享内存上进行通信。现有的内存保护机制，如PMP以及TZASC已经允许保护包括MMIO和DMA在内的任何内存区域。
但是enclave之间的内存共享仍然会危机隐私数据。因此我们提出新的内存架构，每个enclave都有自己的私有内存以及相互之间的共享内存区域。给图1 图2
    如图1，两个复合enclave分别由蓝色和黄色的轮廓表示，这两者分别由两个单元enclave组成:Encl1和连接到内存映射SPI总线上的键盘，Encl2和通过DMA在PCI上连接的GPU。他们的内存划分如图2(这里Encl2和外围设备之间的共享内存区域是MMIO寄存器，
不是DRAM或者DMA)。
    在实际的运行过程中，这些enclave可能会遇到故障，可能在外设没有意识到的情况下被销毁。因此我们需要保障机密数据不会被泄露。因此我们提出这样一种方法:将共享内存区域移动到没有被销毁的单元enclave独占的内存中，以此来异步处理断开连接。
后续的同步断开以及连接可以用于重新建立新的共享内存。
    对于认证机制的改进，

    研究思路
    1、不同类型的unit enclave和专门硬件是否需要进行修改以兼容。
    广泛的专用硬件设备由独特的行为，并且集成到复合enclave中的方式各不相同，从可以想到的最简单的专用设备，一个传感器，到最复杂的设备，数据中心的加速器，我们进行这两种情况的分析，其他大多数设备落在这两个极端示例之间，在此极端之间进行修改。
    传感器只需要最小规模的验证即可，也就是一些对于自身认证的关键材料。在工业上已经有一些工作支持将传感器集成到enclave中，不需要任何的硬件更改。
    加速器往往更加复杂，同时数据中心的加速器可能需要支持多租户使用，因此在加速器上可能需要多个独立的可测试的enclave，保证单个任务的数据。
    2、引入共享内存模型，允许unit enclave以及与专门硬件相互通信。
    通过物理内存保护(PMP)机制，对通信中使用的内存地址访问进行限制，因此不需要对处理器进行任何更改。在我们的设计中使用安全监视器(SM)对专用硬件使用的地址区域进行维护，并且只允许CPU上的单个单元enclave访问专用硬件设备的地址区域。大多数传统的enclave只能通过不受信任的操作系统进行通信。
    专门硬件与处理器之间的同步。如果专门硬件产生新的可用数据，那么会以轮询的方式要求CPU以预定速率检查新数据是否与复合enclave兼容。另一方面，中断使得专门硬件能够通知CPU处理器硬件支持的新数据可用。在我们的设计中，SM将相关中断委托给单元enclave中的中断处理程序，而不是操作系统。没有实现基于中断的同步
    3、修改enclave的生命周期
    由于专门硬件设备是由不受信任的操作系统管理的，因此操作系统可以重新映射设备或者发送重置信号(关闭正在处理敏感数据的GPU，并在运行期间映射一个新的GPU)。这种情况下复合enclave应该停止向专用硬件发送敏感数据，直到新的GPU通过远程验证。
    传统的enclave生命周期包括三个部分:空闲、运行和暂停。新创建的enclave是空闲状态，然后用户进行调用，此时过渡到运行状态，由于操作系统调度器的操作它会被暂停。
    此外，我们引入了两个额外的生命周期事件，连接和断开。复合enclave可能会使用由于断开连接而不再受到保护的内存区域，我们将断开事件分为异步断开和同步断开。如果一个复合enclave中的某个实体死亡，那么另一个实体就会获得共享内存的唯一使用权。我们要求这个实体必须在接受任何命令之前首先接受操作系统向SM发出的同步断开指令。
    如图:enclave1(E1)连接到enclave2(E2)上，E2又连接到专门硬件设备(HW)上，我们将共享内存分别表示为S_{E1,E2}，S_{E2,HW}
        情况1:E1死亡，此时SM对S_{E1,E2}执行E1异步断开，此时唯一归属于E2，在之后的同步断开中将S_{E1,E2}进行销毁。
        情况2:E2死亡，那么这两个共享区域在异步断开期间都被SM修改。此时对于HW需要将其进行重置。
        情况3:HW断开，此时SM将S_{E2,HW}修改为S_{E2}，后续操作系统需要发出同步断开使之无效，并且需要S_{E1,E2}销毁，以防止E1访问HW。
    4、远程验证者对于复合enclave的验证。
    我们给验证者提供一个对于想要进行测试的unit enclave测试。当验证者选中特定的unit enclave，我们将验证报告和所有连接这个unit enclave的标识符列表一起提供给用户。这些标识符由SM提供。之后验证者可以选择从标识符列表里选择测试某些或者全部的unit enclave。
        unit enclave标识符:在新的unit enclave创建时，SM为其分配唯一标识符。
        认证流:如图3，认证过程由远程认证者发起关于E2的认证请求开始。此时SM向用户发送E2的认证报告以及连接的unit enclave标识符。然后验证者对所有的unit enclave进行单独的远程认证。

    软件组成
    复合enclave由三个实体组成:专用硬件设备上的固件、应用程序enclave(AE)，驱动程序enclave(DE)。如图4，我们的模块化方法旨在提供高度灵活性并增加代码重用。
    AE通过共享内存与DE进行通信，然后再与专门的硬件设备通信。
    DE包含和专用硬件进行通信的驱动程序，操作系统以及应用程序enclave不能直接与硬件通信，必须通过DE进行。这样设计的好处是，即便驱动器受损，只会影响到这个DE，而不会影响其他组件。DE在共享内存上维护着AE和专用硬件设备的通信信道。为了简化配置，我们假设每个专用设备只能有一个活动的DE。
    多个AE的情况:一个DE可以同时与多个AE进行连接，这种情况下，由DE进行对每个单独的AE的连接状态进行维护。因为在没有隔离的情况下，一个AE的操作会对其他AE产生影响，在一些设备中，如果DE切换到与不同AE进行的会话时，可能需要对硬件状态进行重置。复杂的加速器可能支持多个孤立的工作负载，因此不需要重置。

    安全性分析

    主要进行如下几个方面的分析:如何实现与恶意操作系统以及恶意专用硬件的隔离；对于侧信道攻击的分析；unit enclave的生命周期事件；复合enclave的认证的安全性。

    隔离:
        恶意操作系统:使用PMP可以配置每个enclave只能访问自己的私有内存，我们使用额外的PMP条目来保护共享内存区域。注意只有最高特权级别，也就是SM能够修改PMP条目。在上下文切换期间，SM会重新配置所有的PMP条目，从而保证正确的内存范围能够被正常使用。对于受保护内存，任何内存访问都会抛出故障异常。硬件页表必须依据PMP规则进行，因此任何没有被配置的页表不可对受保护的内存进行操作。由SM确保共享区域在两个实体之间共享，并且SM需要对共享内存范围进行验证。
        恶意AE或DE:被攻击者控制的操作系统可以生成恶意的DE或AE，然而，用户会在向AE发送隐私数据之前进行远程验证，检查AE和DE的认证报告，如果认证报告与预期不同，则终止。   并且任何DE中的漏洞指挥保留在enclave内，不会传播到其他连接的enclave。通过这种方式，减少了漏洞的潜在影响。
        恶意的专门硬件:物理攻击者超出了本文的范围
        动态重映射攻击:许多专门硬件设备都是即插即用的，因此，操作系统可能会在运行时更改映射，可能会导致机密数据被共享与错误的实体。
        动态重映射的专用硬件设备有如下几种机制:1、由DMA区域进行所有通信；2、由总线控制器驱动所有通信；3、两种机制混合；注意MMIO接口通常不是动态的，因此在运行时不会改变。
        在重映射针对纯DMA设备的攻击时，操作系统将DMA缓冲区映射到不同的地址范围。可能会导致机密数据泄露的点:1、CPU上的unit enclave可以与重新映射的不受信任的设备共享机密数据；设备可能会与处理器上的错误实体共享结果。然而，操作系统需要通知重映射的设备，因此得以解决第二种泄露问题。在其他情况下，必须保证unit enclave的共享内存区域仍然收到PMP条目保护，因此即便在重映射之后，操作系统也无法访问包括机密数据的共享内存区域。
        如果是由总线控制的通信，则总线和附属的驱动程序必须是TCB的一部分，因为它们可能泄露数据。

        侧信道攻击，我们不讨论对其防御，但是有一些针对我们的新的架构的新的侧信道攻击，例如总线争用。在一些极端情况下，总线争用时间可能会导致数据泄露，比如分支的一侧执行总线访问，另一侧没有

    生命周期
        我们在上文中已经介绍了新的两个生命周期，由于这种架构，任何不受信任的实体永远不会访问旧的共享缓冲区，直到同步断开。

    认证
        上文介绍过

    
    FPGA原型
        在FPGA上运行改进的keystone enclave框架。由于核心最初不支持PMP，我们通过SystemVerilog添加了PMP能力，并向页表中放置了额外的单元来检查页表访问。同时修改了SM，以便能够连接两个unit enclave 或unit enclave和专用硬件。具体来说就是添加了connect、sync_disconnect和async_disconnect三个新接口。

    性能评估
        因为复合enclave支持共享内存通信，其通信速度与内存总线提供的速度相同，这比传统TEE相比更快，因为传统TEE中enclave通过操作系统进行通信需要额外的加密步骤。

        上下文切换:如图，我们还测量了单元enclave创建时间，这主要是由于将所有单元enclave从不受信任的操作系统复制到受保护的内存区域所消耗的时间，因此此时间与内存大小存在线性关系。并且我们发现上下文切换时间独立于共享内存大小。

        加速器:由于PMP访问检查对于关键路径的影响，加速器核心速度从750MHZ降低到了666MHZ，而FPU和IPU以较低的时钟变小，因此他们的关键路径不受PMP条目影响。总的来说，整个加速器面积大约减少了7%，时钟频率降低了15%

    总结:
        我们引入了复合enclave，这是一种具有可配置硬件和软件TCB的TEE技术，我们提出了一个基于RISC-V和两个案例研究的原型:i)模拟连接到FPGA板的外围设备，ii) GPU风格的加速器。我们对这两种案例研究的评估表明，上下文切换的性能开销低，以及广泛的专用硬件设备的可行性。